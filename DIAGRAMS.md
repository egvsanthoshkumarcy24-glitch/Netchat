# ðŸŽ¨ NetChat - Architecture & Flow Diagrams

## ðŸ“Š System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NetChat System                               â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    SERVER (Port 8080)                          â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Main Thread                                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ socket() â†’ bind() â†’ listen()                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ accept() [BLOCKING LOOP]                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Check max_clients (10)                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Spawn worker thread per client                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Signal handler registered (SIGINT)                   â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                          â”‚                                     â”‚ â”‚
â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚ â”‚
â”‚  â”‚          â”‚               â”‚               â”‚                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚  â”‚Worker Thread â”‚ â”‚Worker Threadâ”‚ â”‚Worker Threadâ”‚  ... x10   â”‚ â”‚
â”‚  â”‚  â”‚  (Client 1)  â”‚ â”‚  (Client 2) â”‚ â”‚  (Client 3) â”‚             â”‚ â”‚
â”‚  â”‚  â”‚              â”‚ â”‚             â”‚ â”‚             â”‚             â”‚ â”‚
â”‚  â”‚  â”‚â€¢ Authenticateâ”‚ â”‚â€¢ Parse cmds â”‚ â”‚â€¢ Route msgs â”‚             â”‚ â”‚
â”‚  â”‚  â”‚â€¢ Handle msgs â”‚ â”‚â€¢ /pm /join  â”‚ â”‚â€¢ Broadcast  â”‚             â”‚ â”‚
â”‚  â”‚  â”‚â€¢ Log events  â”‚ â”‚â€¢ Broadcast  â”‚ â”‚â€¢ Logging    â”‚             â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Shared Resources (MUTEX PROTECTED)                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  pthread_mutex_t lock;                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  1. Client Array [10]                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     - fd, username, password, room, authenticated        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  2. Log File (chat.log)                                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     - fprintf() + fflush()                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3. Client Count                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚     - Incremented/decremented atomically                 â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â”‚         â”‚               â”‚               â”‚                            â”‚
â”‚         â”‚ TCP Socket    â”‚ TCP Socket    â”‚ TCP Socket                 â”‚
â”‚         â”‚ (127.0.0.1    â”‚ (127.0.0.1    â”‚ (127.0.0.1                â”‚
â”‚         â”‚  :8080)       â”‚  :8080)       â”‚  :8080)                    â”‚
â”‚         â–¼               â–¼               â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  CLIENT 1   â”‚ â”‚  CLIENT 2   â”‚ â”‚  CLIENT 3   â”‚                   â”‚
â”‚  â”‚  (Alice)    â”‚ â”‚  (Bob)      â”‚ â”‚  (Charlie)  â”‚                   â”‚
â”‚  â”‚             â”‚ â”‚             â”‚ â”‚             â”‚                   â”‚
â”‚  â”‚  Room:      â”‚ â”‚  Room:      â”‚ â”‚  Room:      â”‚                   â”‚
â”‚  â”‚  #oslab     â”‚ â”‚  #oslab     â”‚ â”‚  #general   â”‚                   â”‚
â”‚  â”‚             â”‚ â”‚             â”‚ â”‚             â”‚                   â”‚
â”‚  â”‚  Main Threadâ”‚ â”‚  Recv Threadâ”‚ â”‚  Send/Recv  â”‚                   â”‚
â”‚  â”‚  â€¢ send()   â”‚ â”‚  â€¢ recv()   â”‚ â”‚  Threads    â”‚                   â”‚
â”‚  â”‚             â”‚ â”‚             â”‚ â”‚             â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚       â”‚                                                               â”‚
â”‚       â””â”€â”€â”€ User Input (stdin) â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Message Flow Diagrams

### 1. Regular Message (Room-based)

```
Alice (in #oslab)                    Server                    Bob (in #oslab)         Charlie (in #general)
     â”‚                                 â”‚                             â”‚                        â”‚
     â”‚  "Hello everyone!"              â”‚                             â”‚                        â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                             â”‚                        â”‚
     â”‚                                 â”‚                             â”‚                        â”‚
     â”‚                          [Parse message]                      â”‚                        â”‚
     â”‚                          Get Alice's room = "oslab"           â”‚                        â”‚
     â”‚                          Format: [19:45] [#oslab] Alice: Helloâ”‚                        â”‚
     â”‚                                 â”‚                             â”‚                        â”‚
     â”‚                          [Lock mutex]                         â”‚                        â”‚
     â”‚                          Loop through clients:                â”‚                        â”‚
     â”‚                            - Bob: room=oslab, fd!=sender  âœ“   â”‚                        â”‚
     â”‚                            - Charlie: room=general        âœ—   â”‚                        â”‚
     â”‚                          [Unlock mutex]                       â”‚                        â”‚
     â”‚                                 â”‚                             â”‚                        â”‚
     â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
     â”‚                                 â”‚ [19:45] [#oslab] Alice: Helloâ”‚                        â”‚
     â”‚                                 â”‚                             â”‚                        â”‚
     â”‚ [NO ECHO - sender excluded]     â”‚                             â”‚                        â”‚
     â”‚                                 â”‚                             â”‚                   [Nothing]
     â”‚                                 â”‚                             â”‚                        â”‚
     â”‚                          [Log to file]                        â”‚                        â”‚
     â”‚                          fprintf(log, ...)                    â”‚                        â”‚
     â”‚                                 â”‚                             â”‚                        â”‚
```

---

### 2. Private Message Flow

```
Alice                             Server                             Bob
  â”‚                                 â”‚                                 â”‚
  â”‚  /pm Bob Secret message         â”‚                                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                 â”‚
  â”‚                                 â”‚                                 â”‚
  â”‚                          [Parse command]                          â”‚
  â”‚                          Extract:                                 â”‚
  â”‚                            target = "Bob"                         â”‚
  â”‚                            message = "Secret message"             â”‚
  â”‚                                 â”‚                                 â”‚
  â”‚                          [send_private_message()]                 â”‚
  â”‚                          [Lock mutex]                             â”‚
  â”‚                          Search clients[] for "Bob"               â”‚
  â”‚                          Found: Bob, fd=4                         â”‚
  â”‚                          [Unlock mutex]                           â”‚
  â”‚                                 â”‚                                 â”‚
  â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                 â”‚ [PM from Alice]: Secret message â”‚
  â”‚                                 â”‚                                 â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
  â”‚ [PM to Bob]: Secret message     â”‚                                 â”‚
  â”‚                                 â”‚                                 â”‚
  â”‚                          [Log to file]                            â”‚
  â”‚                          [PM] Alice -> Bob: Secret                â”‚
  â”‚                                 â”‚                                 â”‚
```

---

### 3. Join Room Flow

```
Alice (in #general)                Server                    Users in #general       Users in #oslab
      â”‚                              â”‚                             â”‚                      â”‚
      â”‚  /join oslab                 â”‚                             â”‚                      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                             â”‚                      â”‚
      â”‚                              â”‚                             â”‚                      â”‚
      â”‚                       [Parse command]                      â”‚                      â”‚
      â”‚                       Extract: room = "oslab"              â”‚                      â”‚
      â”‚                              â”‚                             â”‚                      â”‚
      â”‚                       [Lock mutex]                         â”‚                      â”‚
      â”‚                       old_room = clients[i].room           â”‚                      â”‚
      â”‚                       clients[i].room = "oslab"            â”‚                      â”‚
      â”‚                       [Unlock mutex]                       â”‚                      â”‚
      â”‚                              â”‚                             â”‚                      â”‚
      â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
      â”‚                              â”‚ [Server]: Alice left #generalâ”‚                      â”‚
      â”‚                              â”‚                             â”‚                      â”‚
      â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                              â”‚       [Server]: Alice joined #oslab                  â”‚
      â”‚                              â”‚                             â”‚                      â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚                      â”‚
      â”‚ [Server]: You joined #oslab  â”‚                             â”‚                      â”‚
      â”‚                              â”‚                             â”‚                      â”‚
```

---

### 4. Authentication Flow

```
Client                                Server
  â”‚                                     â”‚
  â”‚  1. TCP Connect                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                     â”‚
  â”‚  2. send(username)                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                     â”‚
  â”‚  3. send(password)                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                     â”‚
  â”‚                              [authenticate_user()]
  â”‚                              if (password == "chat123")
  â”‚                                     â”‚
  â”‚                                  âœ“ SUCCESS
  â”‚                                     â”‚
  â”‚  4. "Authentication successful!"    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  5. "Welcome to NetChat!"           â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  6. Show commands menu              â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  7. "[Server]: User joined #general"â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  [START CHATTING]                   â”‚
  â”‚                                     â”‚

  Alternative: âœ— AUTHENTICATION FAILURE
  â”‚                                     â”‚
  â”‚  4. "Authentication failed"         â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  5. close(socket)                   â”‚
  â”‚  X                                  â”‚
  â”‚  [DISCONNECTED]                     â”‚
```

---

### 5. Graceful Shutdown Flow

```
Server                      Client 1                Client 2                Client 3
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  [Ctrl+C pressed]         â”‚                       â”‚                       â”‚
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  SIGINT received          â”‚                       â”‚                       â”‚
  â”‚  handle_shutdown()        â”‚                       â”‚                       â”‚
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  server_running = 0       â”‚                       â”‚                       â”‚
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  broadcast_all(           â”‚                       â”‚                       â”‚
  â”‚   "Server shutting down") â”‚                       â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚                      "[Server]: Goodbye!"    "[Server]: Goodbye!"   "[Server]: Goodbye!"
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  [Lock mutex]             â”‚                       â”‚                       â”‚
  â”‚  for each client:         â”‚                       â”‚                       â”‚
  â”‚    close(clients[i].fd)   â”‚                       â”‚                       â”‚
  â”‚  [Unlock mutex]           â”‚                       â”‚                       â”‚
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  X â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ X                       â”‚                       â”‚
  â”‚  X â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ X                       â”‚
  â”‚  X â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€X
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  fclose(log_file)         â”‚                       â”‚                       â”‚
  â”‚  close(server_fd)         â”‚                       â”‚                       â”‚
  â”‚  pthread_mutex_destroy()  â”‚                       â”‚                       â”‚
  â”‚                           â”‚                       â”‚                       â”‚
  â”‚  exit(0)                  â”‚   [Connection lost]   â”‚   [Connection lost]   â”‚
  X                           X                       X                       X
```

---

## ðŸ§µ Thread Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   THREAD LIFECYCLE                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Main Thread                                    Worker Thread
    â”‚                                                â”‚
    â”‚ accept() [BLOCKING]                           â”‚
    â”‚ â—„â”€â”€ Client connects                           â”‚
    â”‚                                               â”‚
    â”‚ pthread_create(&tid, NULL,                    â”‚
    â”‚                 handle_client,                â”‚
    â”‚                 &client_fd)                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ BORN
    â”‚                                               â”‚
    â”‚ pthread_detach(tid)                           â”‚ recv(username)
    â”‚                                               â”‚ recv(password)
    â”‚                                               â”‚ authenticate_user()
    â”‚ [continues accept loop]                       â”‚
    â”‚                                               â”‚ âœ“ Authentication OK
    â”‚                                               â”‚
    â”‚                                               â”‚ while (recv() > 0) {
    â”‚                                               â”‚   parse_message()
    â”‚                                               â”‚   if (/pm) â†’ private
    â”‚                                               â”‚   if (/join) â†’ change room
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   else â†’ broadcast
    â”‚  â”‚ MUTEX PROTECTED CRITICAL SECTION â”‚         â”‚
    â”‚  â”‚                                  â”‚         â”‚   pthread_mutex_lock()
    â”‚  â”‚  Client array modifications      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   [access shared data]
    â”‚  â”‚  Message broadcasting            â”‚         â”‚   pthread_mutex_unlock()
    â”‚  â”‚  Log file writes                 â”‚         â”‚
    â”‚  â”‚                                  â”‚         â”‚   log_message() â† mutex
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ }
    â”‚                                               â”‚
    â”‚                                               â”‚ recv() returns 0
    â”‚                                               â”‚ [Client disconnected]
    â”‚                                               â”‚
    â”‚                                               â”‚ pthread_mutex_lock()
    â”‚                                               â”‚ Remove from clients[]
    â”‚                                               â”‚ pthread_mutex_unlock()
    â”‚                                               â”‚
    â”‚                                               â”‚ close(client_fd)
    â”‚                                               â”‚ return NULL
    â”‚                                               â”‚
    â”‚                                               X DIES
    â”‚ [Auto cleanup via detach]                     
    â”‚                                               
    â”‚ [continues serving other clients]             
    â”‚                                               
```

---

## ðŸ” Thread Synchronization (Mutex)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               MUTEX PROTECTED CRITICAL SECTIONS                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Thread 1                  Mutex Lock              Thread 2
   â”‚                          â”‚                       â”‚
   â”‚  pthread_mutex_lock()    â”‚                       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ LOCKED                â”‚
   â”‚                          â”‚ (Thread 1 owns)       â”‚
   â”‚  [CRITICAL SECTION]      â”‚                       â”‚
   â”‚  â€¢ Access clients[]      â”‚                       â”‚  pthread_mutex_lock()
   â”‚  â€¢ Modify shared data    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚  â€¢ Send to sockets       â”‚                       â”‚               â”‚ WAITING
   â”‚                          â”‚                       â”‚               â”‚ [BLOCKED]
   â”‚  pthread_mutex_unlock()  â”‚                       â”‚               â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ UNLOCKED              â”‚               â”‚
   â”‚                          â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚ LOCKED                â”‚
   â”‚                          â”‚ (Thread 2 owns)       â”‚  [CRITICAL SECTION]
   â”‚                          â”‚                       â”‚  â€¢ Access clients[]
   â”‚                          â”‚                       â”‚  â€¢ Write to log
   â”‚                          â”‚                       â”‚
   â”‚                          â”‚                       â”‚  pthread_mutex_unlock()
   â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚ UNLOCKED              â”‚
   â”‚                          â”‚                       â”‚

Example - broadcast_room():

void broadcast_room(char *msg, int sender_fd, const char *room) {
    pthread_mutex_lock(&lock);     // â—„â”€â”€ ENTRY GATE
    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚    CRITICAL SECTION (Protected)         â”‚
    // â”‚                                         â”‚
    for (int i = 0; i < client_count; i++) {   // â—„â”€â”€ Shared data access
        if (strcmp(clients[i].room, room) == 0 && 
            clients[i].fd != sender_fd) {
            send(clients[i].fd, msg, strlen(msg), 0);
        }
    }
    // â”‚                                         â”‚
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    pthread_mutex_unlock(&lock);   // â—„â”€â”€ EXIT GATE
}
```

---

## ðŸ“ Data Structures

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLIENT STRUCTURE                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

typedef struct {
    int fd;                 // Socket file descriptor (e.g., 3, 4, 5...)
    char username[50];      // "Alice", "Bob", "Charlie"
    char password[50];      // "chat123" (stored for demo)
    int authenticated;      // 0 = no, 1 = yes
    char room[30];         // "general", "oslab", "cnlab"
} Client;

Client clients[10];  // Global array (shared resource)
int client_count;    // Number of active clients (shared resource)
pthread_mutex_t lock; // Protects above shared data

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXAMPLE STATE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

clients[0] = {
    fd: 3,
    username: "Alice",
    password: "chat123",
    authenticated: 1,
    room: "oslab"
}

clients[1] = {
    fd: 4,
    username: "Bob",
    password: "chat123",
    authenticated: 1,
    room: "oslab"
}

clients[2] = {
    fd: 5,
    username: "Charlie",
    password: "chat123",
    authenticated: 1,
    room: "general"
}

client_count = 3
```

---

## ðŸŒŠ Complete Session Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 COMPLETE USER SESSION                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time   Event                          Server Action              User Sees
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

19:40  Server starts                  Open socket, bind, listen  "Server running..."

19:41  Alice connects                 accept() returns fd=3      "Connected..."
       Alice sends username           Store in buffer            
       Alice sends password           authenticate_user()        
       âœ“ Auth success                 clients[0].authenticated=1 "Welcome!"
                                      Join #general              
                                      broadcast_all()            "[Server]: Alice joined"

19:42  Alice: "Hello"                 recv() message             
                                      Format: [19:42][#general]  
                                      broadcast_room()           [19:42][#general]Alice:Hello
                                      log_message()              (written to chat.log)

19:43  Bob connects                   accept() returns fd=4      "Connected..."
       Bob authenticates              Same flow as Alice         "[Server]: Bob joined"

19:44  Bob: "/join oslab"             Parse command              
                                      Old room = "general"       
                                      New room = "oslab"         
                                      Notify old room            "[Server]: Bob left"
                                      Notify new room            "[Server]: Bob joined"

19:45  Alice: "/pm Bob Secret"        Parse /pm command          
                                      Find Bob (fd=4)            
                                      send(4, "[PM from Alice]") [PM from Alice]: Secret
                                      Send confirm to Alice      [PM to Bob]: Secret
                                      log_message("[PM]...")     (written to chat.log)

19:46  Alice: "/join oslab"           Change room = "oslab"      "You joined #oslab"

19:47  Alice: "Hi Bob"                Room = "oslab"             
                                      broadcast_room("oslab")    [19:47][#oslab]Alice:Hi Bob
                                      Only Bob receives (same rm)

19:48  Server: Ctrl+C                 SIGINT signal              
                                      handle_shutdown()          
                                      broadcast_all("Goodbye")   "[Server]: Shutting down"
                                      close all fds              [Connection closed]
                                      exit(0)                    

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ðŸ“Š Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMPLEXITY ANALYSIS                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Operation                   Time Complexity    Space Complexity
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Accept client               O(1)               O(1)
Authenticate                O(1)               O(1)
Find user (private msg)     O(n)               O(1)
Broadcast to room           O(n)               O(1)
Join room                   O(n) [notify]      O(1)
List users                  O(n)               O(1)
List rooms                  O(nÂ²) [dedup]      O(r) r=rooms
Log message                 O(1) [disk I/O]    O(1)

n = number of clients (max 10)
r = number of rooms (max 5)

OPTIMIZATION OPPORTUNITIES:
â€¢ Hash table for usernameâ†’fd: O(n) â†’ O(1)
â€¢ Room membership sets: O(n) â†’ O(m) m=users in room
â€¢ Room list cache: O(nÂ²) â†’ O(1) with updates
```

---

This comprehensive visualization guide covers all architectural aspects! ðŸŽ¨
